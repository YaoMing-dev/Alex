datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
}

// --- CORE MODELS FOR FLASHCARD & QUIZ SYSTEM ---

model Users {
  id                      Int                    @id @default(autoincrement())
  email                   String                 @unique
  username                String
  passwordHash            String?
  refreshToken            String?
  provider                String?                @default("local")
  avatar                  String?
  isVerified              Boolean                @default(false)
  level                   Level                  @default(Beginner)
  created_at              DateTime               @default(now())
  updated_at              DateTime               @updatedAt

  user_flashcard_sets     UserFlashcardSets[]
  quizzes                 Quizzes[]
  quiz_wrong_words        QuizWrongWords[]
}

model Vocab {
  id                      Int                    @id @default(autoincrement())

  internalId              String                 @unique

  word                    String
  type                    String?
  cefr                    String?
  ipa_us                  String?
  ipa_uk                  String?
  meaning_en              String
  meaning_vn              String?
  example                 String?
  audio_url               String?
  audio_url_uk            String?
  created_at              DateTime               @default(now())

  user_flashcard_cards    UserFlashcardCards[]
  quiz_wrong_words        QuizWrongWords[]
}

// --- FLASHCARD MODELS ---

model UserFlashcardSets {
  id                   Int                  @id @default(autoincrement())
  user_id              Int
  set_name             String
  description          String?
  background_color     String               @default("#C8CC77")
  icon                 String?
  width_size           String               @default("medium")
  height_custom        Int?
  theme_tag            String?
  last_studied_at      DateTime?
  created_at           DateTime             @default(now())
  updated_at           DateTime             @updatedAt

  user                 Users                @relation(fields: [user_id], references: [id], onDelete: Cascade)
  user_flashcard_cards UserFlashcardCards[]
  quizzes              Quizzes[]
}

model UserFlashcardCards {
  set_id              Int
  vocab_id            Int
  status              Status               @default(new)

  user_flashcard_sets UserFlashcardSets @relation(fields: [set_id], references: [id], onDelete: Cascade)
  vocab               Vocab             @relation(fields: [vocab_id], references: [id], onDelete: Cascade)

  @@id([set_id, vocab_id])
}

// --- QUIZ MODELS ---

model Quizzes {
  id              Int         @id @default(autoincrement())
  user_id         Int
  type            QuizType
  context         QuizContext @default(general)
  theme_tag       String?
  questions_json  Json
  answers_json    Json
  score           Float
  is_passed       Boolean     @default(false)
  completed_at    DateTime    @default(now())

  flashcard_set_id Int?
  flashcard_set    UserFlashcardSets? @relation(fields: [flashcard_set_id], references: [id])

  user            Users       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  quiz_wrong_words QuizWrongWords[]
}

model QuizWrongWords {
  user_id Int
  quiz_id Int
  vocab_id Int

  user    Users  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  quizzes Quizzes @relation(fields: [quiz_id], references: [id], onDelete: Cascade)
  vocab   Vocab  @relation(fields: [vocab_id], references: [id], onDelete: Cascade)

  @@id([user_id, quiz_id, vocab_id])
}

// --- ENUMS ---

enum Level {
  Beginner
  Intermediate
  Advanced
}

enum Status {
  new
  learned
  review
  mastered
}

enum QuizType {
  multiple_choice
  fill_blank
  connect
  mixed
}

enum QuizContext {
  flashcard_set
  general
}
